define("userPreferences",["lodash","jquery","util","pLoader!santa:utils"],function(a,b,c,d){"use strict";var e=c.serviceTopology.premiumStateApiUrl;e=e?e.replace(/\/getTpaPremiumState/,"-user-preferences-webapp/"):"http://editor.wix.com/_api/wix-user-preferences-webapp/";function f(){var f=null;var g={session:{id:"session",data:{}},site:{id:"site",data:{},urls:{getLoadUrl:function(){return e+"getVolatilePrefsForSite/htmlEditor/"+f},getSaveUrl:function(){return e+"bulkSet"}}},global:{id:"global",data:null,urls:{getLoadUrl:function(){return e+"getVolatilePrefForKey/htmlEditor/global_preferences"},getSaveUrl:function(){return e+"set"}}}};function h(){return c.url.isTrue("fakeUserPrefs")}function i(a){var b=c.url.getParameterByName("resetUserPrefs").toLowerCase();return b==="all"||b===a}function j(b,c){switch(b){case g.global.id:return c.global_preferences;case g.site.id:return a.mapValues(c,function(a){return{value:a,isDirty:false}});default:d.log.error("unknown type ID");return{}}}function k(a,b){g.global.data={};u(g.global.id,a,b)}function l(b,c){a.forEach(g.site.data,function(a){a.value=null;a.isDirty=true});u(g.site.id,b,c)}function m(b){var c={nameSpace:"htmlEditor",siteId:f,data:{}};a.forEach(b,function(a,b){if(a.isDirty){c.data[b]=a.value}});return c}function n(a){return{nameSpace:"htmlEditor",key:"global_preferences",blob:a}}function o(a){switch(a){case g.global.id:return n(g.global.data);case g.site.id:return m(g.site.data)}}function p(b){switch(b){case g.global.id:return{global_preferences:g.global.data};case g.site.id:var c={};a.forEach(g.site.data,function(a,b){c[b]=a.value});return c;default:d.log.error("unknown type ID");return{}}}function q(a,b,c,d){g[a].data=b?j(a,b):{};if(i(a)){t(a,c,d)}else if(c){c()}}function r(b){if(b===g.site.id){a.forEach(g.site.data,function(a){a.isDirty=false})}}function s(a,c,d){if(h()){var e=window.sessionStorage.getItem("user_prefs_"+g[a].id);q(a,JSON.parse(e),c,d);return}b.ajax(g[a].urls.getLoadUrl(),{type:"GET",success:function(b){q(a,b,c,d)},error:function(a){if(d){d(a)}}})}function t(a,b,c){switch(a){case g.global.id:return k(b,c);case g.site.id:return l(b,c)}}function u(a,c,d){if(g[a].data===null){if(d){d("saving "+a+" preferences failed since they were not loaded")}return}if(h()){var e=p(a);window.sessionStorage.setItem("user_prefs_"+g[a].id,JSON.stringify(e));r(a);if(c){c()}return}b.ajax(g[a].urls.getSaveUrl(),{type:"POST",contentType:"application/json; charset=utf-8",data:JSON.stringify(o(a)),success:function(){r(a);if(c){c()}},error:function(a){if(d){d(a)}}})}function v(b,c){b=b||a.noop;c=c||a.noop;function e(a){function e(){if(a&&a.responseText){var b=a.responseText.match(/errorCode="(\d+)"/);b=b&&b[1];return b==="3001"}return false}if(e()){g.global.data={};b();return}g.global.data=null;d.log.error("Global preferences failed to load!");c("Global preferences failed to load!")}s(g.global.id,b,e)}function w(b,c,e,h){var i=a.isEmpty(g.site.data);f=b;if(c){if(!i){u(g.site.id,e,h)}}else if(i){s(g.site.id,e,function(){d.log.error("Site preferences failed to load!");if(h){h("Site preferences failed to load!")}})}else{var j=a.clone(g.site.data);var k=u.bind(this,g.site.id,e,h);var l=function(){g.site.data=a.merge(g.site.data,j);k()};s(g.site.id,l,function(){d.log.error("Site preferences failed to load!");k()})}}return{loadGlobalPreferences:v,loadSitePreferences:w,global:{get:function(b){if(g.global.data===null){d.log.error("Global user preferences failed to load!");return null}if(!a.isString(b)){throw new Error("Getting a global user preference expects a key of type string but received: "+b)}return a.cloneDeep(g.global.data[b])},getAll:function(){if(g.global.data===null){d.log.error("Global user preferences failed to load!");return null}return a.cloneDeep(g.global.data)},set:function(b,c,e,f){if(g.global.data===null){d.log.error("Global user preferences failed to load!");if(f){f("Global user preferences failed to load!")}return}if(!a.isString(b)){throw new Error("Setting a global user preference expects a key of type string but received: "+b)}if(a.isUndefined(c)){c=null}g.global.data[b]=c;u(g.global.id,e,f)}},site:{get:function(b){if(!a.isString(b)){throw new Error("Getting a user preference for the site expects a key of type string but received: "+b)}return a.cloneDeep(g.site.data[b]&&g.site.data[b].value)},getAll:function(){return a.cloneDeep(a.mapValues(g.site.data,"value"))},set:function(b,c,d,e){if(!a.isString(b)){throw new Error("Setting a user preference for the site expects a key of type string but received: "+b)}if(a.isUndefined(c)){c=null}var h={value:c,isDirty:true};g.site.data[b]=h;if(f){u(g.site.id,d,e)}else if(d){d()}}},session:{get:function(b){if(!a.isString(b)){throw new Error("Getting a session user preference expects a key of type string but received: "+b)}return a.cloneDeep(g.session.data[b])},getAll:function(){return a.cloneDeep(g.session.data)},set:function(b,c,d){if(!a.isString(b)){throw new Error("Setting a session user preference expects a key of type string but received: "+b)}g.session.data[b]=c;if(d){d()}return c}}}}return f});